---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# HIEdroughtbox

<!-- badges: start -->
<!-- badges: end -->

The goal of HIEdroughtbox is to facilitate the pre-prepossessing of the data 
produced by the[droughtbox located at the Hawkesbury Institute for the Environment](https://ecamo19.github.io/droughtbox_documentation/) and prepare it 
for calculating tree species branch residual conductance ($g_{res}$) and it's 
temperature dependence ($T_p$). 

However, each dataset generated by the droughtbox has the following issues:

- **The data file generated by the droughtbox has a .dat extension with the 
    first three rows of the data file containing information about the variable 
    measured, the units, and the type of data**. This generates errors when 
    loaded into R with the function read.table(). Thus, the 
    `read_hie_droughtbox_data()` function was developed to consider the unique 
    characteristics of the .dat file.

- **Contains data points outside of the time or dates desired.** This
    happens because the data logger collects all data, which might include
    (among others) data generated by another person on a different day,
    data generated during an undesired hour or data where the droughtbox
    didnâ€™t achieve the climatic conditions desired(i.e. Temperature).
    Because of these issues, the function `filter_droughtbox_data()` was
    developed. With this function, a date or hour (or both) interval can be
    chosen to focus on a specific period.

- **Produce values close to zero (or even negative) and the first and last data 
    points within each taring process are not valid due to temperature drift.** 
    Every 5 minutes the droughtbox automatically tares itself to avoid 
    temperature drift in the measurements. However, this causes that between 
    each taring process, the droughtbox records wrong data points. To overcome 
    these issues the function `clean_droughtbox_data()` was developed. This 
    function removes all values below a desired threshold 
    (the default is 0.2 grams) **AND** the first and last values within each 
    taring process. For example, if a dataframe has 13 measurements and 
    remove_n_observations is equal to 5, then only the observations 6,7,8,9 and 
    10 will be returned. 
    
     
## Installation

You can install the development version of HIEdroughtbox from [GitHub](https://github.com/) with:

```r
# install.packages("devtools")
devtools::install_github("ecamo19/HIEdroughtbox")
```

## Data preprocessing example

```{r libraries, message = FALSE,warning = FALSE}
library(HIEdroughtbox)
library(dplyr)
```

### Read droughtbox data

The first step is reading the data. The `read_hie_droughtbox_data()` only reads
files with the .dat extension that haven't been modified. Thus make sure to 
provide __UNMODIFIED__ files coming from the droughtbox.  

```{r example_load_25c}
acacia_aneura_25c <- read_hie_droughtbox_data("inst/extdata/acacia_aneura_25c.dat")
glimpse(acacia_aneura_25c)
```


```{r example_load_30c, echo=FALSE}
acacia_aneura_30c <- read_hie_droughtbox_data("inst/extdata/acacia_aneura_30c.dat")
```

### Visualize climatic conditions

The droughtbox have sensors that measures the temperature and the relative 
humidity. To visualize the set and measured climatic controls the followiong 
function can be used: 

```{r example_plot_climatic_controls, fig.height=20, fig.width=25}
plot_droughtbox_climatic_controls(acacia_aneura_25c, cowplot = T)
```

### Visualize all weights measured by the droughtbox

With the function `plot_strains_weights` it is possible to visualize all weights 
measured by each strain inside the droughtbox. Also it let you identify to which
taring group does each data point belongs to (denoted as numbers).

```{r example_plot_raw_weights, fig.height=10, fig.width=15}
plot_strains_weights(acacia_aneura_25c, 
                     show_strain = "all",
                     time_breaks = "5 min",
                     show_tare_group = TRUE)
```

```{r fig.height=10, fig.width=15, echo=FALSE, eval=FALSE}
plot_strains_weights(acacia_aneura_30c, 
                     show_strain = "all",
                     time_breaks = "5 min",
                     show_tare_group = TRUE)
```


... or just some strains 

```{r example_plot_raw_weights_1_4, fig.height=10, fig.width=15, warning=FALSE}
plot_strains_weights(acacia_aneura_25c, 
                     show_strain =  "strain_4", 
                     time_breaks = "2 min",
                     show_tare_group = TRUE)
```

### Choose a interval of time

Using the previous plot as reference, I decided to focus only on the data 
collected between 13:10:00 and 15:10:00. 

```{r warning=FALSE, message=FALSE}
acacia_aneura_25c_filtered_data <- filter_droughtbox_data(acacia_aneura_25c,
                                                          from_start_time = "13:10:00",
                                                          to_end_time = "15:10:00")

glimpse(acacia_aneura_25c_filtered_data)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
acacia_aneura_30c_filtered_data <- filter_droughtbox_data(acacia_aneura_30c,
                                                          from_start_time = "17:15:00",
                                                          to_end_time = "19:20:00")

```


```{r example_plot_weights_1_4_filtered_data, fig.height=10, fig.width=15, warning=FALSE}
plot_strains_weights(acacia_aneura_25c_filtered_data, 
                     show_strain = c("strain_1", "strain_4"), 
                     time_breaks = "10 min",
                     show_tare_group = TRUE)
```

### Clean the data

Finally, after filtering the data by the interval of time desired the last 
step is to remove the values close to zero and the first and last points within 
each taring process. 

The following code will remove the values lower than 0.2 grams and the first 10 
and last 10 values of each taring group.  

```{r}
acacia_aneura_25c_cleaned_data <- 
    clean_droughtbox_data(acacia_aneura_25c_filtered_data,
                          remove_n_observations = 5,
                          threshold = 0.2)

glimpse(acacia_aneura_25c_cleaned_data)
```


```{r echo=FALSE, message=FALSE}
acacia_aneura_30c_cleaned_data <- 
    clean_droughtbox_data(acacia_aneura_30c_filtered_data,
                          remove_n_observations = 5,
                          threshold = 0.2)
```

```{r example_plot_weights_all_cleaned_data, fig.height=10, fig.width=15}
plot_strains_weights(acacia_aneura_25c_cleaned_data, 
                     show_strain = "all",
                     time_breaks = "15 min",
                     # If true, this will display the taring group
                     show_tare_group = FALSE)
```

```{r echo=FALSE, eval=FALSE,  fig.height=10, fig.width=15}
plot_strains_weights(acacia_aneura_30c_cleaned_data, 
                     show_strain = "all",
                     time_breaks = "15 min",
                     # If true, this will display the taring group
                     show_tare_group = FALSE)
```


### Merge droughtbox data

```{r warning=FALSE, message=FALSE}
acacia_aneura_merged_data <-
    merge_droughtbox_data(acacia_aneura_25c_cleaned_data,
                          acacia_aneura_30c_cleaned_data)
```


## Calculate the residual conductance of Acacia Aneura

After the raw data has been cleaned 

### Load data with the areas

```{r}
acacia_aneura_leaf_branch_areas <-
    read_hie_droughtbox_leaf_branch_areas("./inst/extdata/acacia_aneura_branch_length_diameter.csv") 

glimpse(acacia_aneura_leaf_branch_areas)
```


```{r}
calculate_residual_conductance(droughtbox_data =  acacia_aneura_merged_data, 
                               leaf_and_branch_area_data = acacia_aneura_leaf_branch_areas) %>% 
    glimpse()
```

