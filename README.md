
<!-- README.md is generated from README.Rmd. Please edit that file -->

# HIEdroughtbox

<!-- badges: start -->
<!-- badges: end -->

The goal of HIEdroughtbox is to facilitate the pre-prepossessing of the
data produced by the[droughtbox located at the Hawkesbury Institute for
the Environment](https://ecamo19.github.io/droughtbox_documentation/)
and prepare it for calculating tree species branch residual conductance
($g_{res}$) and it’s temperature dependence ($T_p$).

However, each dataset generated by the droughtbox has the following
issues:

- **The data file generated by the droughtbox has a .dat extension with
  the first three rows of the data file containing information about the
  variable measured, the units, and the type of data**. This generates
  errors when loaded into R with the function read.table(). Thus, the
  `read_hie_droughtbox_data()` function was developed to consider the
  unique characteristics of the .dat file.

- **Contains data points outside of the time or dates desired.** This
  happens because the data logger collects all data, which might include
  (among others) data generated by another person on a different day,
  data generated during an undesired hour or data where the droughtbox
  didn’t achieve the climatic conditions desired(i.e. Temperature).
  Because of these issues, the function `filter_droughtbox_data()` was
  developed. With this function, a date or hour (or both) interval can
  be chosen to focus on a specific period.

- **Produce values close to zero (or even negative) and the first and
  last data points within each taring process are not valid due to
  temperature drift.** Every 5 minutes the droughtbox automatically
  tares itself to avoid temperature drift in the measurements. However,
  this causes that between each taring process, the droughtbox records
  wrong data points. To overcome these issues the function
  `clean_droughtbox_data()` was developed. This function removes all
  values below a desired threshold (the default is 0.2 grams) **AND**
  the first and last values within each taring process. For example, if
  a dataframe has 13 measurements and remove_n_observations is equal to
  5, then only the observations 6,7,8,9 and 10 will be returned.

## Installation

You can install the development version of HIEdroughtbox from
[GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("ecamo19/HIEdroughtbox")
```

## Data preprocessing example

``` r
library(HIEdroughtbox)
library(dplyr)
```

### Read droughtbox data

The first step is reading the data. The `read_hie_droughtbox_data()`
only reads files with the .dat extension that haven’t been modified.
Thus make sure to provide **UNMODIFIED** files coming from the
droughtbox.

``` r
acacia_aneura_25c <- read_hie_droughtbox_data("inst/extdata/acacia_aneura_25c.dat")
glimpse(acacia_aneura_25c)
Rows: 796
Columns: 17
$ tare_count_smp               <fct> 13, 13, 13, 13, 14, 14, 14, 14, 14, 14, 1…
$ date_time                    <dttm> 2024-03-04 12:51:00, 2024-03-04 12:51:30…
$ date                         <date> 2024-03-04, 2024-03-04, 2024-03-04, 2024…
$ time                         <time> 12:51:00, 12:51:30, 12:52:20, 12:52:20, …
$ air_tc_avg_deg_c_avg         <dbl> 26.76, 26.80, 26.83, 26.83, 27.22, 27.22,…
$ rh_avg_percent_avg           <dbl> 44.05, 43.63, 43.36, 43.36, 39.73, 39.73,…
$ tc_avg_deg_c_avg             <dbl> 27.19, 27.25, 27.29, 27.29, 27.79, 27.79,…
$ set_point_t_avg_avg          <dbl> 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 2…
$ set_point_vpd_avg_avg        <dbl> 1.6, 1.6, 1.6, 1.6, 1.6, 1.6, 1.6, 1.6, 1…
$ set_point_abs_h_avg_avg      <dbl> 11.39, 11.39, 11.39, 11.39, 11.39, 11.39,…
$ vpd_avg_kpa_avg              <dbl> 1.967, 1.986, 1.999, 1.999, 2.177, 2.177,…
$ abs_h_avg_g_m3_avg           <dbl> 11.19, 11.10, 11.05, 11.05, 10.35, 10.35,…
$ set_point_rh_avg_avg         <dbl> 49.48, 49.48, 49.48, 49.48, 49.48, 49.48,…
$ strain_avg_1_microstrain_avg <dbl> 2.472753, 2.489199, 2.505648, 2.505648, 2…
$ strain_avg_2_microstrain_avg <dbl> 2.434764, 2.451971, 2.417776, 2.417776, 2…
$ strain_avg_3_microstrain_avg <dbl> 2.381188, 2.349167, 2.333139, 2.333139, 2…
$ strain_avg_4_microstrain_avg <dbl> 2.310796, 2.310783, 2.327533, 2.327533, 2…
```

### Visualize climatic conditions

The droughtbox have sensors that measures the temperature and the
relative humidity. To visualize the set and measured climatic controls
the followiong function can be used:

``` r
plot_droughtbox_climatic_controls(acacia_aneura_25c, cowplot = T)
```

<img src="man/figures/README-example_plot_climatic_controls-1.png" width="100%" />

### Visualize all weights measured by the droughtbox

With the function `plot_strains_weights` it is possible to visualize all
weights measured by each strain inside the droughtbox. Also it let you
identify to which taring group does each data point belongs to (denoted
as numbers).

``` r
plot_strains_weights(acacia_aneura_25c, 
                     show_strain = "all",
                     time_breaks = "5 min",
                     show_tare_group = TRUE)
`geom_smooth()` using method = 'loess' and formula = 'y ~ x'
```

<img src="man/figures/README-example_plot_raw_weights-1.png" width="100%" />

… or just some strains

``` r
plot_strains_weights(acacia_aneura_25c, 
                     show_strain =  "strain_4", 
                     time_breaks = "2 min",
                     show_tare_group = TRUE)
`geom_smooth()` using method = 'loess' and formula = 'y ~ x'
```

<img src="man/figures/README-example_plot_raw_weights_1_4-1.png" width="100%" />

### Choose a interval of time

Using the previous plot as reference, I decided to focus only on the
data collected between 13:10:00 and 15:10:00.

``` r
acacia_aneura_25c_filtered_data <- filter_droughtbox_data(acacia_aneura_25c,
                                                          from_start_time = "13:10:00",
                                                          to_end_time = "15:10:00")
[1] "Times must have a HH:MM:SS format i.e. 13:53:00"
[1] "Dates must have a YYYY-MM-DD format i.e. 1991-10-19"
[1] "Filtering data by hour from: 13:10:00 to: 15:10:00"

glimpse(acacia_aneura_25c_filtered_data)
Rows: 716
Columns: 17
$ tare_count_smp               <fct> 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 1…
$ date_time                    <dttm> 2024-03-04 13:10:40, 2024-03-04 13:11:00…
$ date                         <date> 2024-03-04, 2024-03-04, 2024-03-04, 2024…
$ time                         <time> 13:10:40, 13:11:00, 13:11:10, 13:11:20, …
$ air_tc_avg_deg_c_avg         <dbl> 27.66, 27.67, 27.68, 27.69, 27.70, 27.70,…
$ rh_avg_percent_avg           <dbl> 35.75, 35.61, 35.49, 35.48, 35.45, 35.24,…
$ tc_avg_deg_c_avg             <dbl> 28.30, 28.26, 28.32, 28.29, 28.32, 28.31,…
$ set_point_t_avg_avg          <dbl> 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 2…
$ set_point_vpd_avg_avg        <dbl> 1.6, 1.6, 1.6, 1.6, 1.6, 1.6, 1.6, 1.6, 1…
$ set_point_abs_h_avg_avg      <dbl> 11.39, 11.39, 11.39, 11.39, 11.39, 11.39,…
$ vpd_avg_kpa_avg              <dbl> 2.381, 2.387, 2.394, 2.394, 2.397, 2.405,…
$ abs_h_avg_g_m3_avg           <dbl> 9.54, 9.51, 9.48, 9.49, 9.48, 9.43, 9.42,…
$ set_point_rh_avg_avg         <dbl> 49.48, 49.48, 49.48, 49.48, 49.48, 49.48,…
$ strain_avg_1_microstrain_avg <dbl> 2.443138, 2.443120, 2.459561, 2.443120, 2…
$ strain_avg_2_microstrain_avg <dbl> 2.465538, 2.448162, 2.465310, 2.448166, 2…
$ strain_avg_3_microstrain_avg <dbl> 2.365185, 2.381247, 2.349241, 2.365244, 2…
$ strain_avg_4_microstrain_avg <dbl> 2.240364, 2.240412, 2.240412, 2.240412, 2…
```

    [1] "Times must have a HH:MM:SS format i.e. 13:53:00"
    [1] "Dates must have a YYYY-MM-DD format i.e. 1991-10-19"
    [1] "Filtering data by hour from: 17:15:00 to: 19:20:00"

``` r
plot_strains_weights(acacia_aneura_25c_filtered_data, 
                     show_strain = c("strain_1", "strain_4"), 
                     time_breaks = "10 min",
                     show_tare_group = TRUE)
`geom_smooth()` using method = 'loess' and formula = 'y ~ x'
```

<img src="man/figures/README-example_plot_weights_1_4_filtered_data-1.png" width="100%" />

### Clean the data

Finally, after filtering the data by the interval of time desired the
last step is to remove the values close to zero and the first and last
points within each taring process.

The following code will remove the values lower than 0.2 grams and the
first 10 and last 10 values of each taring group.

``` r
acacia_aneura_25c_cleaned_data <- 
    clean_droughtbox_data(acacia_aneura_25c_filtered_data,
                          remove_n_observations = 5,
                          threshold = 0.2)
[1] "Total number of rows removed: 656"

glimpse(acacia_aneura_25c_cleaned_data)
Rows: 60
Columns: 17
$ tare_count_smp               <fct> 15, 15, 15, 15, 15, 16, 16, 16, 16, 16, 1…
$ date_time                    <dttm> 2024-03-04 13:11:40, 2024-03-04 13:11:50…
$ date                         <date> 2024-03-04, 2024-03-04, 2024-03-04, 2024…
$ time                         <time> 13:11:40, 13:11:50, 13:12:00, 13:12:10, …
$ air_tc_avg_deg_c_avg         <dbl> 27.70, 27.70, 27.71, 27.71, 27.73, 28.07,…
$ rh_avg_percent_avg           <dbl> 35.24, 35.22, 35.08, 35.14, 35.09, 33.12,…
$ tc_avg_deg_c_avg             <dbl> 28.31, 28.26, 28.35, 28.37, 28.33, 28.69,…
$ set_point_t_avg_avg          <dbl> 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 2…
$ set_point_vpd_avg_avg        <dbl> 1.6, 1.6, 1.6, 1.6, 1.6, 1.6, 1.6, 1.6, 1…
$ set_point_abs_h_avg_avg      <dbl> 11.39, 11.39, 11.39, 11.39, 11.39, 11.39,…
$ vpd_avg_kpa_avg              <dbl> 2.405, 2.405, 2.413, 2.411, 2.415, 2.539,…
$ abs_h_avg_g_m3_avg           <dbl> 9.43, 9.42, 9.39, 9.40, 9.40, 9.04, 9.02,…
$ set_point_rh_avg_avg         <dbl> 49.48, 49.48, 49.48, 49.48, 49.48, 49.48,…
$ strain_avg_1_microstrain_avg <dbl> 2.426678, 2.459589, 2.459589, 2.459589, 2…
$ strain_avg_2_microstrain_avg <dbl> 2.465310, 2.465663, 2.397080, 2.414227, 2…
$ strain_avg_3_microstrain_avg <dbl> 2.365244, 2.349151, 2.365153, 2.349151, 2…
$ strain_avg_4_microstrain_avg <dbl> 2.206874, 2.240336, 2.273875, 2.290644, 2…
```

    [1] "Total number of rows removed: 686"

``` r
plot_strains_weights(acacia_aneura_25c_cleaned_data, 
                     show_strain = "all",
                     time_breaks = "15 min",
                     # If true, this will display the taring group
                     show_tare_group = FALSE)
`geom_smooth()` using method = 'loess' and formula = 'y ~ x'
```

<img src="man/figures/README-example_plot_weights_all_cleaned_data-1.png" width="100%" />

### Merge droughtbox data

``` r
acacia_aneura_merged_data <-
    merge_droughtbox_data(acacia_aneura_25c_cleaned_data,
                          acacia_aneura_30c_cleaned_data)
```

## Calculate the residual conductance of Acacia Aneura

After the raw data has been cleaned

### Load data with the areas

``` r
acacia_aneura_leaf_branch_areas <-
    read_hie_droughtbox_leaf_branch_areas("./inst/extdata/acacia_aneura_branch_length_diameter.csv") 
[1] "surface_branch_area_cm2 aproximated using pi*radius*(length + radius) formula"
[1] "branch_basal_diameter_mm converted to cm and divided by two to get the radius"

glimpse(acacia_aneura_leaf_branch_areas)
Rows: 28
Columns: 6
$ species_name            <chr> "acacia_aneura", "acacia_aneura", "acacia_aneu…
$ sample_id               <int> 1043, 1044, 1045, 1046, 1043, 1044, 1045, 1046…
$ strain_number           <int> 1, 2, 3, 4, 1, 2, 3, 4, 1, 2, 3, 4, 1, 2, 3, 4…
$ set_temperature         <int> 25, 25, 25, 25, 30, 30, 30, 30, 35, 35, 35, 35…
$ leaf_area_cm2           <dbl> 9.640, 10.300, 6.200, 10.250, 17.450, 12.700, …
$ surface_branch_area_cm2 <dbl> 16.49336, 16.49336, 16.49336, 16.49336, 16.493…
```

``` r
calculate_residual_conductance(droughtbox_data =  acacia_aneura_merged_data, 
                               leaf_and_branch_area_data = acacia_aneura_leaf_branch_areas) %>% 
    glimpse()
[1] "Make sure VPD conditions were constant"
[1] "Residual conductance units: grams * s-1 * cm-2"
[1] "Positive slope between weight loss and time found. Check your data"
[1] "Transpiration for gres calculated"
Rows: 28
Columns: 7
$ species_name                    <chr> "acacia_aneura", "acacia_aneura", "aca…
$ sample_id                       <int> 1043, 1044, 1045, 1046, 1043, 1044, 10…
$ strain_number                   <int> 1, 2, 3, 4, 1, 2, 3, 4, 1, 2, 3, 4, 1,…
$ set_temperature                 <int> 25, 25, 25, 25, 30, 30, 30, 30, 35, 35…
$ transpiration_grams_per_sec_cm2 <dbl> 5.351936e-07, -1.163451e-08, 6.956038e…
$ median_vpd                      <dbl> 3.049, 3.049, 3.049, 3.049, 2.520, 2.5…
$ residual_conductance            <dbl> 1.783393e-05, -3.876898e-07, 2.317919e…
```
