---
title: '[spcode]: Residual conductance TPC model selection'
author: 'ecamo19'
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  prettydoc::html_pretty:
    highlight: pygments
    theme: cayman
    toc: yes
    number_sections: no
    toc_depth: 1
---

```{r, setup_wd, include=FALSE}
# Set knit directory
setwd(here::here())
knitr::opts_knit$set(root.dir = setwd(here::here()))
getwd()
```

```{r setup, include = FALSE}
options(scipen = 999)

# Save figures in specific place
knitr::opts_chunk$set(autodep        = TRUE,
                      cache          = FALSE,
                      cache.comments = TRUE,
                      comment = "",
                      # Save figures as pdf ?
                      #dev = c( "png", "pdf"),
                  
                      # Include code?
                      echo           = TRUE,
                      error          = FALSE,
                      fig.align      = "center",
                      
                      # Path where figures are going to be store pdf single 
                      # figures
                      #Edit path in the next line and comment out this line   
                      fig.path       = paste0("./figures_temp_modeling", "/"),
                      fig.width      = 11,
                      fig.height     = 7,
                      message        = FALSE,
                      warning        = FALSE)
```

```{r cleanup-docs, cache = FALSE,echo = FALSE}
# save a html copy file in a specific place
# doc.files <- c(list.files(pattern = "pdf"),
#                list.files(pattern = "html"),
#                list.files(pattern = "docx"))
# 
# for (file in doc.files) {   
#     file.rename(file, file.path("../../[insert_folder_name]/", file))
# }
```

```{r libaries, message = FALSE, warning = FALSE, cache = FALSE}
library(HIEdroughtbox)
library(ggplot2)

# For data manipulation
library(dplyr)
library(purrr)
library(stringr)
library(tidyr)
library(here)
library(broom)
library(tibble)

# For facets_2
library(ggh4x)

# For modeling temperature
library(nls.multstart)
library(rTPC)
library(ggrepel)
```

```{r, echo=FALSE}
string_colors <- c(string_1 = "#eec000",
                   string_2 = "#cf544c",
                   string_3 = "#0175c3",
                   string_4 = "#878687",
                   
                   string_5 =  "#000000",
                   string_6 =  "#008b28",
                   string_7 =  "#8600b6",
                   string_8 =  "#00a0ab")
```

```{r, echo=FALSE}
# write function to label ggplot2 panels
label_facets_num <- function(string){
  len <- length(string)
  string = paste('(', 1:len, ') ', string, sep = '')
  return(string)
}
```

# 1. Load data

```{r}
load("./[spcode]_processed_data/[spcode]_residual_conductance.RData")
ls()
```

# Thermal Performance Curve parameters definitions

![Thermal Performance Curve](https://www.researchgate.net/profile/Luis-Miguel-Gutierrez-Pesquera/publication/303825084/figure/fig16/AS:669082739290125@1536533164346/A-typical-thermal-performance-curve-in-ectotherms-CTmax-critical-thermal-maxima-CTmin.ppm)


+ Activation energy:

+ rmax:

+ topt: Estimate optimum temperature of a thermal performance curve

+ ctmin:

+ ctmax:  Critical thermal maximum is calculated by predicting over a 
          temperature range 50 ºC beyond the maximum value in the dataset. The 
          predicted rate value closest to 0 is then extracted. When this is 
          impossible due to the curve formula (i.e the Sharpe-Schoolfield model), 
          the temperature where the rate is 5 percent of the maximum rate is 
          estimated. Predictions are done every 0.001 ºC so the estimate of the 
          critical thermal maximum should be accurate up to 0.001 ºC
          
          
+ e:

+ eh:

+ Q10: The Q10 temperature coefficient is a measure of temperature sensitivity 
       based on the chemical reactions. (Source Wiki)
       
+ thermal_safety_margin: Measure used to understand the thermal sensitivity of 
                          organisms relative to environmental temperatures. They 
                          are generally estimated as the temperature differential 
                          between the highest temperature an organism can tolerate 
                          (critical thermal maximum, CT_max) and the mean or 
                          maximum environmental temperature it experiences.


+ thermal_tolerance:


+ breadth:  Thermal performance breadth is calculated as the range of 
            temperatures over which a curve's rate is at least 0.8 of peak. This 
            defaults to a proportion of 0.8 but can be changed using the level 
            argument.

+ skewess:                          
                          
# 1. Model thermal response of Residual conductance

## Select string   

```{r eval=FALSE}
#[spcode]_string_NUMBER_data <- 
    [spcode]_residual_conductance %>% 
    ungroup() %>% 
  
    filter(string_number == "string_#")  %>%
  
    select(temperature_measured, 
           double_sided_residual_conductance_mmol_s_m2) %>% 
  
    rename(rate = "double_sided_residual_conductance_mmol_s_m2",
           temp = "temperature_measured")  
```

### Plot string selected 

```{r, raw_data_string, eval=FALSE}
ggplot(data = [spcode]_string_NUMBER_data, aes(x = temp, y = rate)) +
    geom_point() +
    theme_bw()
```

### Fit models for the string selected 

```{r, model_fitting_string, eval=FALSE, cache=TRUE, echo=FALSE}
#models_fits_string_NUMBER <- 
    nest([spcode]_string_NUMBER_data, data = c(temp, rate)) %>%
    mutate(
    
    # Model 8
    delong = map(data, ~suppressWarnings(nls_multstart(rate~delong_2017(temp = temp, c, eb, ef, tm,ehc),
                            data = .x,
                            
                            iter = c(6,6,6,6,6),
                            
                            start_lower = get_start_vals(.x$temp, .x$rate, model_name='delong_2017')-1,
                            
                            start_upper = get_start_vals(.x$temp, .x$rate, model_name='delong_2017')+1,
                            
                            lower = get_lower_lims(.x$temp, .x$rate, model_name = 'delong_2017'),
                            
                            upper = get_upper_lims(.x$temp, .x$rate, model_name = 'delong_2017'),
                            supp_errors = 'Y',
                            lhstype = 'genetic',
                            convergence_count = FALSE))),    
    
    # Model 8
    johnson_lewin = map(data, ~suppressWarnings(nls_multstart(rate~johnsonlewin_1946(temp =temp,r0,e,eh,topt),
                            data = .x,
                            
                            iter = c(6, 6, 6, 6),
                            
                            start_lower = get_start_vals(.x$temp, .x$rate, model_name='johnsonlewin_1946')-1,
                            
                            start_upper = get_start_vals(.x$temp, .x$rate, model_name='johnsonlewin_1946')+1,
                            
                            lower = get_lower_lims(.x$temp, .x$rate, model_name = 'johnsonlewin_1946'),
                            
                            upper = get_upper_lims(.x$temp, .x$rate, model_name = 'johnsonlewin_1946'),
                            supp_errors = 'Y',
                            lhstype = 'genetic',
                            convergence_count = FALSE))),
    
      {print("8) Johnson/Lewin model done"); .},

        

      # Model 11
      pawar = map(data, ~nls_multstart(rate~pawar_2018(temp = temp, r_tref, e, eh, topt, tref = 15),
                                       data = .x,
                                       
                                       iter = c(6, 6, 6, 6),
                                       
                                       start_lower = get_start_vals(.x$temp, 
                                                                    .x$rate, 
                                                                    model_name = 'pawar_2018') - 1,
                                       
                                       start_upper = get_start_vals(.x$temp, 
                                                                    .x$rate, 
                                                                    model_name = 'pawar_2018') + 1,
                                       
                                       lower = get_lower_lims(.x$temp, 
                                                              .x$rate, 
                                                              model_name = 'pawar_2018'),
                                       
                                       upper = get_upper_lims(.x$temp, 
                                                              .x$rate, 
                                                              model_name = 'pawar_2018'),
                                       supp_errors = 'Y',
                                       lhstype = 'genetic',
                                       convergence_count = FALSE)),
    
      {print("11) Pawar model done"); .},
    
      # Model 15
      sharpeschoolfull = map(data, ~nls_multstart(rate~sharpeschoolfull_1981(temp = temp,r_tref,
                                                                             e,el,tl,eh,th, 
                                                                             tref = 25),
                                                  data = .x,
                                                  
                                                  iter = c(6, 6, 6, 6, 6, 6),
                            
                                                  start_lower = get_start_vals(.x$temp,.x$rate,
                                                                    model_name = 'sharpeschoolfull_1981')-1,
                                                  
                                                  start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                    model_name = 'sharpeschoolfull_1981')+1,
                                                  
                                                  lower = get_lower_lims(.x$temp, .x$rate, 
                                                                      model_name = 'sharpeschoolfull_1981'),
                                                  
                                                  upper = get_upper_lims(.x$temp, 
                                                                         .x$rate, 
                                                                         model_name ='sharpeschoolfull_1981'),
                                                  supp_errors = 'Y',
                                                  lhstype = 'genetic',
                                                  convergence_count = FALSE)),
    
      {print("15) Sharpeshoolfull model done"); .},

      # Model 16 
      sharpeschoolhigh = map(data, 
                             ~nls_multstart(rate~sharpeschoolhigh_1981(temp = temp, r_tref,e,eh,th, tref=25),
                                        
                                        data = .x,
                                        iter = c(6, 6, 6, 6),
                                            
                                        start_lower = get_start_vals(.x$temp,.x$rate, 
                                                                     model_name = 'sharpeschoolhigh_1981')-1,
                                        
                                        start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                     model_name = 'sharpeschoolhigh_1981')+1,
                                        
                                        lower = get_lower_lims(.x$temp,
                                                               .x$rate,
                                                               model_name = 'sharpeschoolhigh_1981'),
                                        
                                        upper = get_upper_lims(.x$temp, .x$rate, 
                                                               model_name = 'sharpeschoolhigh_1981'),
                                        supp_errors = 'Y',
                                        lhstype = 'genetic',
                                        convergence_count = FALSE)),
    
      {print("16) Sharpeshoolhigh model done"); .},

      # Model 17
      sharpeschoollow = map(data, ~nls_multstart(rate~sharpeschoollow_1981(temp = temp, r_tref,e,el,tl, 
                                                                           tref = 25),
                                          data = .x,
                                          
                                          iter = c(6, 6, 6, 6),
                                                  
                                          start_lower=get_start_vals(.x$temp,.x$rate,
                                                                     model_name='sharpeschoollow_1981')-1,
                            
                                          start_upper=get_start_vals(.x$temp,.x$rate,
                                                                     model_name = 'sharpeschoollow_1981')+1,
                                          
                                          lower = get_lower_lims(.x$temp, .x$rate, 
                                                                 model_name = 'sharpeschoollow_1981'),
                                          
                                          upper = get_upper_lims(.x$temp, .x$rate, 
                                                                 model_name = 'sharpeschoollow_1981'),
                                          supp_errors = 'Y',
                                          lhstype = 'genetic',
                                          convergence_count = FALSE)),
    
      {print("17) Sharpeshoolhollow model done"); .})
```

### Stack models

```{r eval=FALSE}
#model_stack_string_NUMBER <- 
    select(models_fits_string_NUMBER, -data) %>%
    pivot_longer(., names_to = 'model_name', values_to = 'fit', beta:weibull)
```

### Get model parameters

```{r, eval=FALSE}
#string_NUMBER_params <- 
    model_stack_string_NUMBER %>%
    mutate(., est = map(fit, tidy)) %>%
    select(-fit) %>%
    unnest(est)
```

### Get predictions 

```{r eval=FALSE}
#newdata <- 
  tibble(temp = seq(min([spcode]_string_NUMBER_data$temp),
                    max([spcode]_string_NUMBER_data$temp),
                    length.out = 100))
```

```{r, eval=FALSE}
#string_NUMBER_preds <- 
    model_stack_string_NUMBER %>%
    mutate(., preds = map(fit, augment, newdata = newdata)) %>%
    select(-fit) %>%
    unnest(preds)
```

```{r eval=FALSE}
# take a random point from each model for labelling
d_labs <- filter(string_NUMBER_preds, temp <= 40) %>%
  group_by(., model_name) %>%
  sample_n(., 1) %>%
  ungroup()
```

#### Plot predictions

```{r, plot_model_fits_all_models, eval=FALSE}
ggplot(string_NUMBER_preds, aes(temp, rate)) +
  geom_point(aes(temp, rate), [spcode]_string_NUMBER_data) +
  
  geom_line(aes(temp, .fitted), col = 'blue') +
  
  facet_wrap(~model_name, labeller = labeller(model_name = label_facets_num),
             scales = 'free', ncol = 5) +
  
  theme_bw(base_size = 12) +
  
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  
  labs(x = 'Temperature (ºC)',
       y = 'Residual conductance',
       title = 'Model fits') +
  
  geom_hline(aes(yintercept = 0), linetype = 2)
```

```{r, plot_join_model_fits, eval=FALSE, echo=FALSE}
# ggplot(string_NUMBER_preds, aes(temp, .fitted)) +
#   
#   geom_line(aes(col = model_name)) +
#   
#   geom_label_repel(aes(temp, .fitted, label = model_name, col = model_name),
#                    fill = 'white', nudge_y = 0.8, segment.size = 0.2,
#                    segment.colour = 'grey50', d_labs) +
# 
#   geom_point(aes(temp, rate), [spcode]_string_NUMBER_data) +
#   
#   theme_bw(base_size = 12) +
#   
#   theme(legend.position = 'none') +
#   
#   labs(x = 'Temperature (ºC)',
#        y = 'Residual conductance') +
# 
#   ylim(c(-40000, 40000)) +
#   
#   geom_hline(aes(yintercept = 0), linetype = 2) +
#   
#   scale_color_brewer(type = 'qual', palette = 2)
```

### Get AIC values

```{r eval=FALSE}
#string_NUMBER_ic_values <- 
    model_stack_string_NUMBER %>%
        mutate(., info = map(fit, glance), AICc =  map_dbl(fit, MuMIn::AICc)) %>%
        select(-fit) %>%
        unnest(info) %>%
        select(model_name, sigma, AIC, AICc, BIC, df.residual) %>%  
        mutate(., weight = MuMIn::Weights(AICc)) %>% 
        arrange(., desc(weight)) %>% 
        add_column(string_number = "string_NUMBER")

knitr::kable(string_NUMBER_ic_values)
```

### Model averaging

For a model averaging approach, predictions and parameters from the models are 
averaged. In ecology, this is usually done based on each model’s weighting. The 
best supported model’s predictions are taken into account more than the least 
supported. Often the number of models is reduced by setting a cut-off for the 
difference in the information criterion metric being used. A common approach is 
to only keep models within $\Delta2AIC$ of the best model.

```{r, eval=FALSE, echo=FALSE}
# model_average_string_1 <- 
#     select(string_1_ic_values, model_name, weight) %>% 
#     left_join(., string_1_preds) %>% 
#     group_by(temp) %>%
#     summarise(., .fitted = sum(.fitted*weight)) %>%
#     ungroup() %>%
#     mutate(model_name = 'model average')
```

```{r, eval=FALSE, echo=FALSE}
# d_labs <- filter(model_average_string_1, temp < 30) %>% sample_n(., 1)
```

```{r, plot_model_average, echo=FALSE}
# ggplot(string_1_preds, aes(temp, .fitted)) +
#   geom_line(aes(col = model_name), alpha = 0.3) +
#   geom_line(data = model_average_string_1, col = 'blue') + 
# 
#   geom_label_repel(aes(label = model_name), fill = 'white', nudge_y = 0.8, 
#                       segment.size = 0.2, segment.colour = 'grey50',
#                        data = d_labs, col = 'blue') +
#   
#   geom_point(aes(temp, rate),euc_tere_eucface_string_1) +
#   theme_bw() +
#   theme(legend.position = 'none') +
#   geom_hline(aes(yintercept = 0), linetype = 2) +
#   scale_color_brewer(type = 'qual', palette = 2)
```


```{r, eval=FALSE, echo=FALSE}
# get averaged parameters based on model weights
#thermal_parameters_string_1_model_average <- 
#    select(d_ic, model_name, weight) %>% 
#
#    left_join(.,params) %>%
#    summarise(., across(rmax:skewness, function(x){sum(x*.$weight)})) %>%  
#    mutate(model_name = 'model average')
```

```{r, eval=FALSE, echo=FALSE}
#bind_rows(select(params, model_name, rmax:skewness), ave_params) %>%
#  mutate_if(is.numeric, round, 2)
```

# 2. Export data

```{r, export_aic_values, eval=FALSE}
save(string_NUMBER_ic_values, 
    file = "./[spcode]_processed_data/[spcode]_string_NUMBER_rtpc_aic_models_values.RData")
```

