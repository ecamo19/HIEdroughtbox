---
title: 'Species Name'
author: 'Your Name'
date: '`r format(Sys.time(), '%d %B, %Y')`'
output:
  prettydoc::html_pretty:
    highlight: pygments
    theme: cayman
    toc: yes
    number_sections: no
    toc_depth: 1
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, comment = "", 
                      fig.align = 'center',
					  fig.width = 11, fig.height = 7)
```

```{r, setup_wd, include=FALSE}
# Set knit directory in case rmarkdown fails to render
#knitr::opts_knit$set(root.dir = '/')
```

```{r knitr, include = FALSE}

# Save figures in specific place
knitr::opts_chunk$set(autodep        = TRUE,
                      cache          = FALSE,
                      cache.comments = TRUE,
                      
                      # Save figures as pdf ?
                      #dev = c( "png", "pdf"),
                  
                      # Include code?
                      echo           = TRUE,
                      error          = FALSE,
                      fig.align      = "center",
                      
                      # Path where figures are going to be store pdf single 
                      # figures
                      Edit path in line 44 and comment out this line   
                      fig.path       = paste0("./figures_[sp_name]_gres", "/"),
                      fig.width      = 11,
                      fig.height     = 7,
                      message        = FALSE,
                      warning        = FALSE)
```

```{r cleanup-docs, cache = FALSE,echo = FALSE}
# save a html copy file in a specific place
# doc.files <- c(list.files(pattern = "pdf"),
#                list.files(pattern = "html"),
#                list.files(pattern = "docx"))
# 
# for (file in doc.files) {   
#     file.rename(file, file.path("../../[insert_folder_name]/", file))
# }
```

```{r libaries, message = FALSE, warning = FALSE, cache = FALSE}
library(HIEdroughtbox)
library(dplyr)
library(ggplot2)
library(here)
library(purrr)
library(reticulate)
```

```{r}
getwd()
```

# 1. Load Droughtbox data

```{r, raw_data_list}

# Create list with all data frames
[sp_name]_raw_data <- read_hie_droughtbox_data_folder("./")
```

```{r}

# Show the names of each element in the list
names([sp_name]_raw_data)
```

# 2. Data preprocessing

## Plot climatic data

```{r, plot_climatic_controls}
map([sp_name]_raw_data, plot_droughtbox_climatic_controls)
```

## Plot raw droughtbox data

```{r, plot_raw_data}
map([sp_name]_raw_data, plot_strains_weights)
```

## Clean data

### File 1

```{r}
#[sp_name]_25c_cleaned <- 
    
    # Select the data to be clean
    [sp_name]_raw_data["file_name_25c.dat"] %>% 
    
    # Transform list element to dataframe type
    as.data.frame(.) %>%

    # clean colnames
    `colnames<-`(str_extract(colnames(.), '\\b\\w+$')) %>%

   # Choose a interval of time
    filter_droughtbox_data(.,
                           from_start_time = "HH:MM:SS",
                           to_end_time = "HH:MM:SS") %>% 
    # Clean the data
    clean_droughtbox_data(.,
                          remove_n_observations = 5,
                          threshold = 0.2)
```

### Plot cleaned data

```{r, plot_cleaned_data_25c}
plot_strains_weights([sp_name]_25c_cleaned, show_tare_group = FALSE)
```

### File 2

```{r}
#[sp_name]_30c_cleaned <- 
    
    # Select the data to be clean
    [sp_name]_raw_data["file_name_30c.dat"] %>% 
    
    # Transform list element to dataframe type
    as.data.frame(.) %>%

    # clean colnames
    `colnames<-`(str_extract(colnames(.), '\\b\\w+$')) %>%

    # Choose a interval of time
    filter_droughtbox_data(.,
                           from_start_time = "HH:MM:SS",
                           to_end_time = "HH:MM:SS") %>% 
    # Clean the data
    clean_droughtbox_data(.,
                          remove_n_observations = 5,
                          threshold = 0.2)
    
```

### Plot cleaned data

```{r, plot_cleaned_data_30c}
plot_strains_weights([sp_name]_30c_cleaned, show_tare_group = FALSE)
```

### File 3

```{r}
#[sp_name]_35c_cleaned <- 
    
    # Select the data to be clean
    [sp_name]_raw_data["file_name_35c.dat"] %>% 
    
    # Transform list element to dataframe type
    as.data.frame(.) %>%

    # clean colnames
    `colnames<-`(str_extract(colnames(.), '\\b\\w+$')) %>%

    # Choose a interval of time
    filter_droughtbox_data(.,
                           from_start_time = "HH:MM:SS",
                           to_end_time = "HH:MM:SS") %>% 
    # Clean the data
    clean_droughtbox_data(.,
                          remove_n_observations = 5,
                          threshold = 0.2)
    
```

### Plot cleaned data

```{r, plot_cleaned_data_35c}
plot_strains_weights([sp_name]_35c_cleaned, show_tare_group = FALSE)
```

### File 4

```{r}
#[sp_name]_40c_cleaned <- 
    
    # Select the data to be clean
    [sp_name]_raw_data["file_name_40c.dat"] %>% 
    
    # Transform list element to dataframe type
    as.data.frame(.) %>%

    # clean colnames
    `colnames<-`(str_extract(colnames(.), '\\b\\w+$')) %>%

    # Choose a interval of time
    filter_droughtbox_data(.,
                           from_start_time = "HH:MM:SS",
                           to_end_time = "HH:MM:SS") %>% 
    # Clean the data
    clean_droughtbox_data(.,
                          remove_n_observations = 5,
                          threshold = 0.2)
    
```

### Plot cleaned data

```{r, plot_cleaned_data_40c}
plot_strains_weights([sp_name]_40c_cleaned, show_tare_group = FALSE)
```

### File 5

```{r}
#[sp_name]_45c_cleaned <- 
    
    # Select the data to be clean
    [sp_name]_raw_data["file_name_45c.dat"] %>% 
    
    # Transform list element to dataframe type
    as.data.frame(.) %>%

    # clean colnames
    `colnames<-`(str_extract(colnames(.), '\\b\\w+$')) %>%

   # Choose a interval of time
    filter_droughtbox_data(.,
                           from_start_time = "HH:MM:SS",
                           to_end_time = "HH:MM:SS") %>% 
    # Clean the data
    clean_droughtbox_data(.,
                          remove_n_observations = 5,
                          threshold = 0.2)
```

### Plot cleaned data

```{r, plot_cleaned_data_45c}
plot_strains_weights([sp_name]_45c_cleaned, show_tare_group = FALSE)
```

### File 6

```{r}
#[sp_name]_50c_cleaned <- 
    
    # Select the data to be clean
    [sp_name]_raw_data["file_name_50c.dat"] %>% 
    
    # Transform list element to dataframe type
    as.data.frame(.) %>%

    # clean colnames
    `colnames<-`(str_extract(colnames(.), '\\b\\w+$')) %>%

   # Choose a interval of time
    filter_droughtbox_data(.,
                           from_start_time = "HH:MM:SS",
                           to_end_time = "HH:MM:SS") %>% 
    # Clean the data
    clean_droughtbox_data(.,
                          remove_n_observations = 5,
                          threshold = 0.2)
```

### Plot cleaned data

```{r, plot_cleaned_data_50c}
plot_strains_weights([sp_name]_50c_cleaned, show_tare_group = FALSE)
```

### File 7

```{r}
#[sp_name]_55c_cleaned <- 
    
    # Select the data to be clean
    [sp_name]_raw_data["file_name_55c.dat"] %>% 
    
    # Transform list element to dataframe type
    as.data.frame(.) %>%

    # clean colnames
    `colnames<-`(str_extract(colnames(.), '\\b\\w+$')) %>%

    # Choose a interval of time
    filter_droughtbox_data(.,
                           from_start_time = "HH:MM:SS",
                           to_end_time = "HH:MM:SS") %>% 
    # Clean the data
    clean_droughtbox_data(.,
                          remove_n_observations = 5,
                          threshold = 0.2)
```

### Plot cleaned data

```{r, plot_cleaned_data_55c}
plot_strains_weights([sp_name]_55c_cleaned, show_tare_group = FALSE)
```

## Merge cleaned dataframes

```{r}
#[sp_name]_cleaned_data <- 
                    merge_droughtbox_data([sp_name]_25c_cleaned,
                                          [sp_name]_30c_cleaned,
                                          [sp_name]_35c_cleaned,
                                          [sp_name]_40c_cleaned,
                                          [sp_name]_45c_cleaned,
                                          [sp_name]_50c_cleaned,
                                          [sp_name]_55c_cleaned)
```


# 3. Calculate Branch areas

```{python}
import cv2
import os
from os.path import join
from os import listdir
```

```{python}
# Function for cropping images
def crop_images_for_imagej(path, blur = 25):

    # Validate inputs ---------------------------------------------------------

    # Make sure dir exists
    if not os.path.isdir(path):
        raise ValueError(
            f'Directory: {path} not found exist. Check presence or spelling'
        )

    # Crop images -------------------------------------------------------------

    # Set working directory
    os.chdir(path)

    # Set image coordiantes for removing 2x2 squared tag in all images.
    # The coordinates were obtained using gThumb
    width = 2504
    height = 2961
    x = 46
    y = 546

    file_count = 0

    # Loop over each file
    for each_file in listdir(path):

        # Create folder to store the cropped images
        if not os.path.isdir('cropped_images_for_imagej'):
            os.mkdir(f'./cropped_images_for_imagej')

        if each_file.endswith('.jpg'):

            # Create path to image
            image_path = join(path, each_file)

            print(f'Cropping: {each_file}')

            # Read image
            img = cv2.imread(image_path, 0)

            # Crop image
            cropped_image = img[y:y + height, x:x + width]

            # Apply filter to image for improving quality
            cropped_image = cv2.medianBlur(cropped_image, blur)

            # Save image
            cv2.imwrite(f'./cropped_images_for_imagej/cropped_{each_file}', cropped_image)

            # Count the number of files read
            file_count += 1

        else:
            print(f'{each_file} is not jpg file')

    return(f'Total number of images cropped: {file_count}')
```

```{python}
path = "path/to/scanned_images"
crop_images_for_imagej(path = path)
```

```{r, ImageJ code, eval = FALSE, echo = FALSE}
# Save the code below as leaf_area_300dpi.txt
# 
# Then open ImageJ, go to Plugins -> Macros -> Run -> Select leaf_area_300dpi.txt
# 
# Then select the folder with the cropped images

macro "Leaf batch [b]" {
  dir1 = getDirectory("Choose Source Directory ");
  list = getFileList(dir1);
  for (i=0; i<list.length; i++) {
     showProgress(i+1, list.length);
	open(dir1+list[i]);
	leafArea();
     close();
  }
}

macro "Leaf area [a]" 
{
	leafArea();
}

function leafArea()
 {
var dpi = 300;
var pixelsPerCentimeter = dpi / 2.54; // 300 dpi
run("Clear Results");
run("Set Scale...", "distance=" + pixelsPerCentimeter + " known=1 pixel=1 unit=cm");
//run("Subtract Background...", "rolling=50 light");
run("Make Binary");
//run("Fill Holes");
//run("Remove Outliers...", "radius=10 threshold=50 which=Dark");
run("Create Selection");
run("Set Measurements...", "area redirect=None decimal=3");
run("Analyze Particles...", "size=0-Infinity circularity=0.00-1.00 show=Nothing display clear");
run("Summarize");
var area = getResult("Area"); // this will get the last line of the results, the max
getStatistics(area);
print(getTitle(), area);
}
```

# 4. Calculate Residual conductance

## Load Areas data

```{r}
[sp_name]_areas_data <-
    read_hie_droughtbox_leaf_branch_areas("../[file_name].xlsx")
```




